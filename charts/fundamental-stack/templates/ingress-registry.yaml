{{/*
=============================================================================
Registry Ingress - CRITICAL
=============================================================================
Exposes the container registry (in namespace container-registry) to:
  registry.academind.ir

Features:
- Basic Authentication (required for push/pull)
- TLS termination
- Large file upload support for container images
- Cross-namespace service reference

IMPORTANT: This ingress references a service in ANOTHER namespace
(container-registry). This is done using ExternalName service.
=============================================================================
*/}}
{{- if .Values.registryIngress.enabled }}
---
{{/*
First, create an ExternalName service to reference the registry in another namespace.
This is a Kubernetes pattern for cross-namespace service access.
*/}}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "fundamental-stack.fullname" . }}-registry-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fundamental-stack.backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: registry
spec:
  type: ExternalName
  externalName: {{ .Values.registryIngress.service.name }}.{{ .Values.registryIngress.service.namespace }}.svc.cluster.local
  ports:
    - port: {{ .Values.registryIngress.service.port | default 5000 }}
      targetPort: {{ .Values.registryIngress.service.port | default 5000 }}
      protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "fundamental-stack.fullname" . }}-registry
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fundamental-stack.backend.labels" . | nindent 4 }}
    app.kubernetes.io/component: registry
  {{- with .Values.registryIngress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  ingressClassName: {{ .Values.registryIngress.className | default "nginx" }}
  
  {{- if .Values.registryIngress.tls }}
  tls:
    - hosts:
        - {{ .Values.registryIngress.host | quote }}
      secretName: {{ .Values.registryIngress.tls.secretName | default (printf "%s-registry-tls" (include "fundamental-stack.fullname" .)) }}
  {{- end }}
  
  rules:
    - host: {{ .Values.registryIngress.host | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                # Use the ExternalName service we created above
                name: {{ include "fundamental-stack.fullname" . }}-registry-external
                port:
                  number: {{ .Values.registryIngress.service.port | default 5000 }}
{{- end }}
