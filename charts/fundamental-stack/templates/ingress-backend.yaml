{{/*
=============================================================================
Backend Ingress
=============================================================================
Routes /api/* traffic to Backend service with path rewriting:
- dev.academind.ir/api/health → backend:8080/health
- dev.academind.ir/api/symbols → backend:8080/symbols

The rewrite-target annotation strips the /api prefix because the backend
routes don't have an /api prefix.
=============================================================================
*/}}
{{- if and .Values.ingress.enabled .Values.backend.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "fundamental-stack.fullname" . }}-backend
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fundamental-stack.backend.labels" . | nindent 4 }}
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # Rewrite /api/* to /* when forwarding to backend
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: {{ .Values.ingress.className | default "public" }}
  
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "fundamental-stack.backend.fullname" $ }}
                port:
                  number: {{ $.Values.backend.service.port | default 80 }}
    {{- end }}
{{- end }}
