# =============================================================================
# Sentry Self-Hosted - Ansible Playbook
# =============================================================================
# Deploys a full-featured self-hosted Sentry instance with:
# - Session Replay
# - Source Maps (JavaScript & .NET PDB)
# - GitHub Integration
# - Performance Monitoring
# - Profiling
# =============================================================================
---
- name: Deploy Sentry Self-Hosted
  hosts: vps
  become: yes

  vars:
    # Sentry configuration
    sentry_version: "24.11.1"
    sentry_domain: "sentry.academind.ir"
    sentry_namespace: "sentry"
    
    # Enable Relay for SDK event ingestion (required for Sentry 24.x+)
    sentry_relay_enabled: true
    
    # CSRF trusted origins for frontend
    sentry_csrf_trusted_origins:
      - "https://sentry.academind.ir"
      - "https://dev.academind.ir"
      - "https://academind.ir"

    # Admin credentials (should be in vault)
    sentry_admin_email: "{{ sentry_admin_email | default('admin@academind.ir') }}"
    sentry_admin_password: "{{ sentry_admin_password | default(lookup('password', '/dev/null length=24 chars=ascii_letters,digits')) }}"

    # Secret key for Sentry (50+ chars)
    sentry_secret_key: "{{ sentry_secret_key | default(lookup('password', '/dev/null length=64 chars=ascii_letters,digits')) }}"

    # Database credentials
    sentry_postgres_password: "{{ sentry_postgres_password | default(lookup('password', '/dev/null length=24 chars=ascii_letters,digits')) }}"
    sentry_redis_password: "{{ sentry_redis_password | default(lookup('password', '/dev/null length=24 chars=ascii_letters,digits')) }}"

    # GitHub Integration (optional)
    sentry_github_enabled: true
    sentry_github_app_id: ""
    sentry_github_app_name: "Sentry-Fundamental"
    sentry_github_client_id: ""
    sentry_github_client_secret: ""
    sentry_github_webhook_secret: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    # Mail configuration
    sentry_mail_enabled: false
    sentry_mail_host: "smtp.gmail.com"
    sentry_mail_port: 587
    sentry_mail_username: ""
    sentry_mail_password: ""
    sentry_mail_from: "sentry@academind.ir"

    # Storage paths
    sentry_data_path: "/opt/sentry/data"

  tasks:
    # =========================================================================
    # Prerequisites
    # =========================================================================
    - name: Create Sentry namespace
      shell: |
        microk8s kubectl create namespace {{ sentry_namespace }} --dry-run=client -o yaml | microk8s kubectl apply -f -
      changed_when: false

    - name: Create Sentry data directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ sentry_data_path }}"
        - "{{ sentry_data_path }}/postgres"
        - "{{ sentry_data_path }}/redis"
        - "{{ sentry_data_path }}/kafka"
        - "{{ sentry_data_path }}/clickhouse"
        - "{{ sentry_data_path }}/symbolicator"
        - "{{ sentry_data_path }}/files"
        - "{{ sentry_data_path }}/geoip"

    # =========================================================================
    # Secrets
    # =========================================================================
    - name: Create Sentry secrets
      shell: |
        cat <<EOF | microk8s kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: sentry-secrets
          namespace: {{ sentry_namespace }}
        type: Opaque
        stringData:
          secret-key: "{{ sentry_secret_key }}"
          postgres-password: "{{ sentry_postgres_password }}"
          redis-password: "{{ sentry_redis_password }}"
          admin-email: "{{ sentry_admin_email }}"
          admin-password: "{{ sentry_admin_password }}"
        {% if sentry_github_enabled and sentry_github_client_id %}
          github-app-id: "{{ sentry_github_app_id }}"
          github-client-id: "{{ sentry_github_client_id }}"
          github-client-secret: "{{ sentry_github_client_secret }}"
          github-webhook-secret: "{{ sentry_github_webhook_secret }}"
        {% endif %}
        {% if sentry_mail_enabled %}
          mail-password: "{{ sentry_mail_password }}"
        {% endif %}
        EOF
      changed_when: false
      no_log: true

    # =========================================================================
    # ConfigMaps
    # =========================================================================
    - name: Create Sentry config
      shell: |
        cat <<'EOF' | microk8s kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: sentry-config
          namespace: {{ sentry_namespace }}
        data:
          sentry.conf.py: |
            # =============================================================================
            # Sentry Configuration
            # =============================================================================
            import os

            # =============================================================================
            # General
            # =============================================================================
            SENTRY_URL_PREFIX = "https://{{ sentry_domain }}"
            CSRF_TRUSTED_ORIGINS = ["https://{{ sentry_domain }}"]
            SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
            SESSION_COOKIE_SECURE = True
            CSRF_COOKIE_SECURE = True

            # Secret key
            SECRET_KEY = os.environ.get("SENTRY_SECRET_KEY")

            # =============================================================================
            # Database
            # =============================================================================
            DATABASES = {
                "default": {
                    "ENGINE": "sentry.db.postgres",
                    "NAME": "sentry",
                    "USER": "sentry",
                    "PASSWORD": os.environ.get("POSTGRES_PASSWORD"),
                    "HOST": "sentry-postgres",
                    "PORT": "5432",
                    "CONN_MAX_AGE": 600,
                    "CONN_HEALTH_CHECKS": True,
                }
            }

            # =============================================================================
            # Redis
            # =============================================================================
            SENTRY_OPTIONS["redis.clusters"] = {
                "default": {
                    "hosts": {
                        0: {
                            "host": "sentry-redis",
                            "port": 6379,
                            "password": os.environ.get("REDIS_PASSWORD"),
                        }
                    }
                }
            }

            # =============================================================================
            # Kafka
            # =============================================================================
            SENTRY_OPTIONS["kafka-common"] = {"bootstrap.servers": "sentry-kafka:9092"}

            # =============================================================================
            # Feature Flags - Enable All Features
            # =============================================================================
            SENTRY_FEATURES = {
                # Session Replay
                "organizations:session-replay": True,
                "organizations:session-replay-ui": True,
                "organizations:session-replay-sdk-errors-only": True,
                "organizations:session-replay-combined-envelope-items": True,

                # Performance Monitoring
                "organizations:performance-view": True,
                "organizations:performance-span-histogram-view": True,
                "organizations:performance-trace-details": True,
                "organizations:performance-tracing-without-performance": True,

                # Profiling
                "organizations:profiling": True,
                "organizations:profiling-ui": True,
                "organizations:profiling-global-suspect-functions": True,

                # Issue Platform
                "organizations:issue-platform": True,
                "organizations:issue-details-tag-page": True,

                # Metrics
                "organizations:custom-metrics": True,
                "organizations:metrics-extraction": True,
                "organizations:ddm-ui": True,

                # Source Maps & Debug Files
                "organizations:source-maps-cta": True,
                "organizations:symbol-sources": True,

                # GitHub Integration
                "organizations:integrations-stacktrace-link": True,
                "organizations:integrations-codeowners": True,

                # Discover & Dashboards
                "organizations:discover-basic": True,
                "organizations:discover-query": True,
                "organizations:dashboards-basic": True,
                "organizations:dashboards-edit": True,
                "organizations:dashboards-template": True,

                # Alerts
                "organizations:incidents": True,
                "organizations:metric-alert-threshold-period": True,
                "organizations:alert-wizard-v3": True,

                # Other Features
                "organizations:global-views": True,
                "organizations:team-insights": True,
                "organizations:project-detail": True,
                "organizations:new-widget-builder-experience": True,
            }

            # =============================================================================
            # Symbolicator (Source Maps & Debug Symbols)
            # =============================================================================
            SENTRY_OPTIONS["symbolicator.enabled"] = True
            SENTRY_OPTIONS["symbolicator.options"] = {
                "url": "http://sentry-symbolicator:3021",
            }

            # =============================================================================
            # Relay
            # =============================================================================
            SENTRY_RELAY_WHITELIST_PK = []
            SENTRY_RELAY_OPEN_REGISTRATION = True

            {% if sentry_github_enabled and sentry_github_client_id %}
            # =============================================================================
            # GitHub Integration
            # =============================================================================
            GITHUB_APP_ID = os.environ.get("GITHUB_APP_ID", "")
            GITHUB_API_SECRET = os.environ.get("GITHUB_CLIENT_SECRET", "")
            GITHUB_REQUIRE_VERIFIED_EMAIL = False
            {% endif %}

            {% if sentry_mail_enabled %}
            # =============================================================================
            # Mail Configuration
            # =============================================================================
            SENTRY_OPTIONS["mail.host"] = "{{ sentry_mail_host }}"
            SENTRY_OPTIONS["mail.port"] = {{ sentry_mail_port }}
            SENTRY_OPTIONS["mail.username"] = "{{ sentry_mail_username }}"
            SENTRY_OPTIONS["mail.password"] = os.environ.get("MAIL_PASSWORD", "")
            SENTRY_OPTIONS["mail.use-tls"] = True
            SENTRY_OPTIONS["mail.from"] = "{{ sentry_mail_from }}"
            {% endif %}

            # =============================================================================
            # Beacon (anonymous usage stats to Sentry)
            # =============================================================================
            SENTRY_BEACON = False

          config.yml: |
            # =============================================================================
            # Sentry YAML Config
            # =============================================================================
            system.url-prefix: "https://{{ sentry_domain }}"
            system.internal-url-prefix: "http://sentry-web:9000"

            # File storage
            filestore.backend: "filesystem"
            filestore.options:
              location: "/data/files"

            # Enable all processing features
            relay.processing.enabled: true
            processing.verify-events: true

            # ClickHouse for analytics
            snuba.host: "sentry-snuba-api"
            snuba.port: 1218

          relay-config.yml: |
            # Relay configuration
            relay:
              mode: managed
              upstream: "http://sentry-web:9000/"
              host: 0.0.0.0
              port: 3000

            processing:
              enabled: true
              kafka_config:
                - name: "bootstrap.servers"
                  value: "sentry-kafka:9092"

            # Enable all processing
            limits:
              max_concurrent_requests: 100
              max_concurrent_queries: 50
        EOF
      changed_when: false

    # =========================================================================
    # Persistent Volume Claims
    # =========================================================================
    - name: Create PVCs
      shell: |
        cat <<EOF | microk8s kubectl apply -f -
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-postgres-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-redis-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-kafka-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-clickhouse-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-zookeeper-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-files-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-symbolicator-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: microk8s-hostpath
        EOF
      changed_when: false

    # =========================================================================
    # Deploy Sentry Stack
    # =========================================================================
    - name: Deploy Sentry services
      shell: |
        cat <<'EOF' | microk8s kubectl apply -f -
        {{ lookup('template', 'sentry-deployment.yaml.j2') }}
        EOF
      changed_when: false

    # =========================================================================
    # Wait for services
    # =========================================================================
    - name: Wait for PostgreSQL to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-postgres -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 3
      delay: 10

    - name: Wait for Redis to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-redis -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 3
      delay: 10

    # =========================================================================
    # Initialize Sentry
    # =========================================================================
    - name: Run Sentry migrations
      shell: |
        microk8s kubectl run sentry-init --rm -it --restart=Never \
          --image=getsentry/sentry:{{ sentry_version }} \
          --namespace={{ sentry_namespace }} \
          --env="SENTRY_SECRET_KEY={{ sentry_secret_key }}" \
          --env="POSTGRES_PASSWORD={{ sentry_postgres_password }}" \
          --env="REDIS_PASSWORD={{ sentry_redis_password }}" \
          --env="SENTRY_POSTGRES_HOST=sentry-postgres" \
          --env="SENTRY_REDIS_HOST=sentry-redis" \
          --command -- sentry upgrade --noinput
      changed_when: false
      ignore_errors: yes

    - name: Create admin user
      shell: |
        microk8s kubectl run sentry-createuser --rm -it --restart=Never \
          --image=getsentry/sentry:{{ sentry_version }} \
          --namespace={{ sentry_namespace }} \
          --env="SENTRY_SECRET_KEY={{ sentry_secret_key }}" \
          --env="POSTGRES_PASSWORD={{ sentry_postgres_password }}" \
          --env="SENTRY_POSTGRES_HOST=sentry-postgres" \
          --command -- sentry createuser --email {{ sentry_admin_email }} --password {{ sentry_admin_password }} --superuser --no-input
      changed_when: false
      ignore_errors: yes
      no_log: true

  handlers:
    - name: Restart Sentry services
      shell: |
        microk8s kubectl rollout restart deployment -n {{ sentry_namespace }} -l app.kubernetes.io/part-of=sentry
