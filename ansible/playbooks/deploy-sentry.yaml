# =============================================================================
# Sentry Self-Hosted - Ansible Playbook
# =============================================================================
# Deploys a full-featured self-hosted Sentry instance with:
# - Session Replay
# - Source Maps (JavaScript & .NET PDB)
# - GitHub Integration
# - Performance Monitoring
# - Profiling
# =============================================================================
---
- name: Deploy Sentry Self-Hosted
  hosts: vps
  become: yes

  vars:
    # Sentry configuration
    sentry_version: "24.11.1"
    sentry_domain: "sentry.academind.ir"
    sentry_namespace: "sentry"
    
    # Enable Relay for SDK event ingestion (required for Sentry 24.x+)
    sentry_relay_enabled: true
    
    # CSRF trusted origins for frontend
    sentry_csrf_trusted_origins:
      - "https://sentry.academind.ir"
      - "https://dev.academind.ir"
      - "https://academind.ir"

    # Admin credentials (should be in vault)
    sentry_admin_email: "admin@academind.ir"
    _sentry_admin_password_default: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
    sentry_admin_password: "{{ _sentry_admin_password_default }}"

    # Secret key for Sentry (50+ chars)
    _sentry_secret_key_default: "{{ lookup('password', '/dev/null length=64 chars=ascii_letters,digits') }}"
    sentry_secret_key: "{{ _sentry_secret_key_default }}"

    # Database credentials
    _sentry_postgres_password_default: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
    sentry_postgres_password: "{{ _sentry_postgres_password_default }}"
    _sentry_redis_password_default: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
    sentry_redis_password: "{{ _sentry_redis_password_default }}"

    # GitHub Integration (optional)
    sentry_github_enabled: true
    sentry_github_app_id: ""
    sentry_github_app_name: "Sentry-Fundamental"
    sentry_github_client_id: ""
    sentry_github_client_secret: ""
    sentry_github_webhook_secret: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    # Mail configuration
    sentry_mail_enabled: false
    sentry_mail_host: "smtp.gmail.com"
    sentry_mail_port: 587
    sentry_mail_username: ""
    sentry_mail_password: ""
    sentry_mail_from: "sentry@academind.ir"

    # Storage paths
    sentry_data_path: "/opt/sentry/data"

  tasks:
    # =========================================================================
    # Prerequisites
    # =========================================================================
    - name: Create Sentry namespace
      shell: |
        microk8s kubectl create namespace {{ sentry_namespace }} --dry-run=client -o yaml | microk8s kubectl apply -f -
      changed_when: false

    - name: Create Sentry data directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ sentry_data_path }}"
        - "{{ sentry_data_path }}/postgres"
        - "{{ sentry_data_path }}/redis"
        - "{{ sentry_data_path }}/kafka"
        - "{{ sentry_data_path }}/clickhouse"
        - "{{ sentry_data_path }}/symbolicator"
        - "{{ sentry_data_path }}/files"
        - "{{ sentry_data_path }}/geoip"

    # =========================================================================
    # Secrets
    # =========================================================================
    - name: Create Sentry secrets
      shell: |
        cat <<EOF | microk8s kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: sentry-secrets
          namespace: {{ sentry_namespace }}
        type: Opaque
        stringData:
          secret-key: "{{ sentry_secret_key }}"
          postgres-password: "{{ sentry_postgres_password }}"
          redis-password: "{{ sentry_redis_password }}"
          admin-email: "{{ sentry_admin_email }}"
          admin-password: "{{ sentry_admin_password }}"
        {% if sentry_github_enabled and sentry_github_client_id %}
          github-app-id: "{{ sentry_github_app_id }}"
          github-client-id: "{{ sentry_github_client_id }}"
          github-client-secret: "{{ sentry_github_client_secret }}"
          github-webhook-secret: "{{ sentry_github_webhook_secret }}"
        {% endif %}
        {% if sentry_mail_enabled %}
          mail-password: "{{ sentry_mail_password }}"
        {% endif %}
        EOF
      changed_when: false
      no_log: true

    # =========================================================================
    # NOTE: ConfigMap is defined in templates/sentry-deployment.yaml.j2
    # It includes all necessary configurations for:
    # - SECRET_KEY using SENTRY_OPTIONS (not deprecated SECRET_KEY)
    # - Proper Redis, Kafka, Snuba configurations
    # - CSRF and proxy settings
    # - Disabled internal SDK
    # =========================================================================

    # =========================================================================
    # Persistent Volume Claims
    # =========================================================================
    - name: Create PVCs
      shell: |
        cat <<EOF | microk8s kubectl apply -f -
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-postgres-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-redis-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-kafka-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-clickhouse-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-zookeeper-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-files-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: microk8s-hostpath
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sentry-symbolicator-pvc
          namespace: {{ sentry_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: microk8s-hostpath
        EOF
      changed_when: false

    # =========================================================================
    # Deploy Sentry Stack
    # =========================================================================
    - name: Deploy Sentry services
      shell: |
        cat <<'EOF' | microk8s kubectl apply -f -
        {{ lookup('template', '../templates/sentry-deployment.yaml.j2') }}
        EOF
      changed_when: false

    # =========================================================================
    # Wait for services
    # =========================================================================
    - name: Wait for PostgreSQL to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-postgres -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 3
      delay: 10

    - name: Wait for Redis to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-redis -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 3
      delay: 10

    - name: Wait for Kafka to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-kafka -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 5
      delay: 30

    - name: Wait for Sentry web pod to be ready (needs it for migrations)
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-web -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 5
      delay: 30

    # =========================================================================
    # Initialize Sentry Database
    # =========================================================================
    - name: Run Sentry database migrations
      shell: |
        microk8s kubectl exec -n {{ sentry_namespace }} deploy/sentry-web -- sentry upgrade --noinput 2>&1 || true
      changed_when: false
      retries: 3
      delay: 30
      ignore_errors: yes

    - name: Create admin user
      shell: |
        microk8s kubectl exec -n {{ sentry_namespace }} deploy/sentry-web -- sentry createuser --email {{ sentry_admin_email }} --password {{ sentry_admin_password }} --superuser --no-input 2>&1 || true
      changed_when: false
      no_log: true

    # =========================================================================
    # Wait for Snuba API to be ready before running migrations
    # =========================================================================
    - name: Wait for Snuba API to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-snuba-api -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 5
      delay: 30

    - name: Wait for ClickHouse to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-clickhouse -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 5
      delay: 30

    # =========================================================================
    # Run Snuba migrations to create ClickHouse tables
    # This is required for organization volume metrics and event processing
    # =========================================================================
    - name: Run Snuba migrations
      shell: |
        microk8s kubectl exec -n {{ sentry_namespace }} deploy/sentry-snuba-api -- snuba migrations migrate --force 2>&1 || true
      changed_when: false
      retries: 3
      delay: 30
      ignore_errors: yes

    # =========================================================================
    # Restart services to pick up all configurations
    # =========================================================================
    - name: Restart Sentry web and workers after migrations
      shell: |
        microk8s kubectl rollout restart deployment/sentry-web deployment/sentry-worker deployment/sentry-cron -n {{ sentry_namespace }}
      changed_when: false

    - name: Wait for Sentry web to be ready
      shell: |
        microk8s kubectl wait --for=condition=ready pod -l app=sentry-web -n {{ sentry_namespace }} --timeout=300s
      changed_when: false
      retries: 3
      delay: 10

    # =========================================================================
    # Save and Display Credentials
    # =========================================================================
    - name: Save Sentry credentials to file
      copy:
        content: |
          # ================================================
          # Sentry Credentials - Generated by Ansible
          # ================================================
          # URL: https://{{ sentry_domain }}
          # 
          # Admin Login:
          #   Email: {{ sentry_admin_email }}
          #   Password: {{ sentry_admin_password }}
          #
          # Database (PostgreSQL):
          #   Host: sentry-postgres.{{ sentry_namespace }}.svc.cluster.local
          #   User: sentry
          #   Password: {{ sentry_postgres_password }}
          #
          # Redis:
          #   Host: sentry-redis.{{ sentry_namespace }}.svc.cluster.local
          #   Password: {{ sentry_redis_password }}
          #
          # Secret Key: {{ sentry_secret_key }}
          # ================================================
        dest: "{{ credentials_dir | default('/root/.fundamental-credentials') }}/sentry-credentials.txt"
        mode: "0600"

    - name: Display Sentry credentials
      debug:
        msg: |
          
          ╔══════════════════════════════════════════════════════════════╗
          ║                    SENTRY DEPLOYMENT COMPLETE                 ║
          ╠══════════════════════════════════════════════════════════════╣
          ║  URL: https://{{ sentry_domain }}
          ║                                                              
          ║  Admin Login:                                                
          ║    Email:    {{ sentry_admin_email }}
          ║    Password: {{ sentry_admin_password }}
          ║                                                              
          ║  Credentials saved to:                                       
          ║    {{ credentials_dir | default('/root/.fundamental-credentials') }}/sentry-credentials.txt
          ╚══════════════════════════════════════════════════════════════╝

  handlers:
    - name: Restart Sentry services
      shell: |
        microk8s kubectl rollout restart deployment -n {{ sentry_namespace }} -l app.kubernetes.io/part-of=sentry
