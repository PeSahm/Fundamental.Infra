---
# Full Stack Deployment Playbook
# ==============================
# Complete deployment of Fundamental platform from scratch
#
# This playbook runs all setup steps in the correct order:
# 0. Terraform (DNS, GitHub configuration) - runs on localhost
# 1. VPS Setup (Docker, MicroK8s, UFW)
# 2. Registry Proxy Setup
# 3. Cert-Manager Setup (ClusterIssuers)
# 4. Kubernetes Secrets
# 5. ArgoCD Installation
# 6. Kubernetes Dashboard
# 7. Sentry Deployment
# 8. GitHub Actions Runner (if token provided)
# 9. Application Deployment (Backend, Frontend, Migrations via ArgoCD)
#
# Prerequisites:
#   cd /path/to/Fundamental.Infra
#   source infrastructure/.env
#
# Usage:
#   ansible-playbook -i ansible/inventory/hosts.ini ansible/playbooks/full-deploy.yaml
#
# With GitHub Runner (requires token from GitHub Settings > Actions > Runners > New):
#   ansible-playbook -i ansible/inventory/hosts.ini ansible/playbooks/full-deploy.yaml \
#     -e "github_runner_token=YOUR_TOKEN"
#
# Variables:
#   terraform_environment: dev (default) or prod
#   deploy_branch: main (default) or develop
#   github_runner_token: (optional) for self-hosted runner setup

- name: "Step 0: Setup Terraform (DNS + GitHub)"
  ansible.builtin.import_playbook: setup-terraform.yaml

- name: "Step 1: Setup VPS Infrastructure"
  ansible.builtin.import_playbook: setup-vps.yaml

- name: "Step 2: Setup Registry Proxy"
  ansible.builtin.import_playbook: setup-registry-proxy.yaml

- name: "Step 3: Setup Cert-Manager ClusterIssuers"
  ansible.builtin.import_playbook: setup-cert-manager.yaml

- name: "Step 4: Setup Kubernetes Secrets"
  ansible.builtin.import_playbook: setup-kubernetes-secrets.yaml

- name: "Step 5: Setup ArgoCD"
  ansible.builtin.import_playbook: setup-argocd.yaml

- name: "Step 6: Setup Kubernetes Dashboard"
  ansible.builtin.import_playbook: setup-kubernetes-dashboard.yaml

- name: "Step 7: Deploy Sentry"
  ansible.builtin.import_playbook: deploy-sentry.yaml

- name: "Step 8: Setup GitHub Actions Runner (if token provided)"
  ansible.builtin.import_playbook: setup-github-runner.yaml
  when: github_runner_token is defined and github_runner_token != ''

- name: "Step 9: Deploy Applications"
  ansible.builtin.import_playbook: deploy-applications.yaml

# Final summary is displayed by deploy-applications.yaml


