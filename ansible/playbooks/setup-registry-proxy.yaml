---
# Registry Setup Playbook
# =======================
# Configures MicroK8s container registry for external access
# The registry is exposed via Kubernetes Ingress (not host nginx)
#
# This playbook:
# 1. Generates registry credentials
# 2. Configures containerd to trust the registry
# 3. Updates Kubernetes secrets for image pull
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/setup-registry-proxy.yaml
#
# The actual registry ingress is managed by Helm chart (registryIngress in values)

- name: Setup Container Registry
  hosts: vps
  become: true
  gather_facts: true

  vars:
    # registry_domain loaded from group_vars/all.yaml
    microk8s_registry_port: 32000
    # Generate htpasswd credentials (username from group_vars)
    registry_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"

  tasks:
    # =========================================
    # Install apache2-utils for htpasswd
    # =========================================
    - name: Install apache2-utils for htpasswd
      ansible.builtin.apt:
        name:
          - apache2-utils
        state: present
        update_cache: true

    # =========================================
    # Configure MicroK8s to trust the registry
    # =========================================
    - name: Create MicroK8s containerd hosts directory
      ansible.builtin.file:
        path: /var/snap/microk8s/current/args/certs.d/{{ registry_domain }}
        state: directory
        mode: '0755'

    - name: Configure MicroK8s to trust registry
      ansible.builtin.copy:
        content: |
          server = "https://{{ registry_domain }}"
          
          [host."https://{{ registry_domain }}"]
            capabilities = ["pull", "resolve", "push"]
            # Trust the certificate (handled by cert-manager + ingress)
            skip_verify = false
        dest: /var/snap/microk8s/current/args/certs.d/{{ registry_domain }}/hosts.toml
        mode: '0644'
      notify: Restart MicroK8s containerd

    # =========================================
    # Save registry credentials
    # =========================================
    - name: Create credentials directory
      ansible.builtin.file:
        path: /root/.fundamental-credentials
        state: directory
        mode: '0700'

    - name: Save registry credentials
      ansible.builtin.copy:
        content: |
          # Container Registry Credentials
          # Generated: {{ ansible_date_time.iso8601 }}
          
          Registry URL:  https://{{ registry_domain }}
          Username:      {{ registry_username }}
          Password:      {{ registry_password }}
          
          Docker Login:
            docker login {{ registry_domain }} -u {{ registry_username }} -p '{{ registry_password }}'
        dest: /root/.fundamental-credentials/registry-credentials.txt
        mode: '0600'
      no_log: true

    # =========================================
    # Update Kubernetes secrets with registry credentials
    # =========================================
    - name: Update registry secret in fundamental-dev
      ansible.builtin.shell: |
        microk8s kubectl create secret docker-registry registry-credentials \
          --namespace=fundamental-dev \
          --docker-server='{{ registry_domain }}' \
          --docker-username='{{ registry_username }}' \
          --docker-password='{{ registry_password }}' \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Update registry secret in fundamental-prod
      ansible.builtin.shell: |
        microk8s kubectl create secret docker-registry registry-credentials \
          --namespace=fundamental-prod \
          --docker-server='{{ registry_domain }}' \
          --docker-username='{{ registry_username }}' \
          --docker-password='{{ registry_password }}' \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    # =========================================
    # Create htpasswd file for ingress basic auth
    # =========================================
    - name: Generate htpasswd file
      ansible.builtin.shell: |
        htpasswd -cb /tmp/registry-htpasswd '{{ registry_username }}' '{{ registry_password }}'
      no_log: true
      changed_when: true

    - name: Create registry-auth secret in fundamental-dev
      ansible.builtin.shell: |
        microk8s kubectl create secret generic registry-auth \
          --namespace=fundamental-dev \
          --from-file=auth=/tmp/registry-htpasswd \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Create registry-auth secret in fundamental-prod
      ansible.builtin.shell: |
        microk8s kubectl create secret generic registry-auth \
          --namespace=fundamental-prod \
          --from-file=auth=/tmp/registry-htpasswd \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Clean up htpasswd file
      ansible.builtin.file:
        path: /tmp/registry-htpasswd
        state: absent

    # =========================================
    # Verification
    # =========================================
    - name: Display registry info
      ansible.builtin.debug:
        msg:
          - "‚úÖ Registry credentials configured"
          - "üåê URL: https://{{ registry_domain }}"
          - "üë§ Username: {{ registry_username }}"
          - "üîë Credentials saved to: /root/.fundamental-credentials/registry-credentials.txt"
          - ""
          - "‚ÑπÔ∏è  Registry is exposed via Kubernetes Ingress (managed by Helm)"
          - "üìã Secrets created: registry-credentials, registry-auth"

    # =========================================
    # Fetch credentials to local
    # =========================================
    - name: Fetch registry credentials to local machine
      ansible.builtin.fetch:
        src: /root/.fundamental-credentials/registry-credentials.txt
        dest: "{{ playbook_dir }}/../.credentials/{{ inventory_hostname }}-registry.txt"
        flat: true
      no_log: true

  handlers:
    - name: Restart MicroK8s containerd
      ansible.builtin.shell: |
        microk8s stop
        sleep 5
        microk8s start
        microk8s status --wait-ready
      async: 300
      poll: 10
