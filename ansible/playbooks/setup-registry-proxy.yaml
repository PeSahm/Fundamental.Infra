---
# Registry Setup Playbook
# =======================
# Configures MicroK8s container registry for external access
# The registry is exposed via Kubernetes Ingress (not host nginx)
#
# This playbook:
# 1. Loads or generates registry credentials (persistent)
# 2. Configures containerd to trust the registry
# 3. Updates Kubernetes secrets for image pull
#
# IMPORTANT: Password is persisted in /root/.fundamental-credentials/registry-password
#            To force regeneration, delete that file before running
#
# After running this playbook, run setup-github-secrets.yaml to sync credentials:
#   ansible-playbook playbooks/setup-github-secrets.yaml
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/setup-registry-proxy.yaml

- name: Setup Container Registry
  hosts: vps
  become: true
  gather_facts: true

  vars:
    # registry_domain loaded from group_vars/all.yaml
    microk8s_registry_port: 32000
    # Password is loaded from file or generated (see pre_tasks)
    registry_password_file: /root/.fundamental-credentials/registry-password

  pre_tasks:
    # =========================================
    # Ensure credentials directory exists
    # =========================================
    - name: Create credentials directory
      ansible.builtin.file:
        path: /root/.fundamental-credentials
        state: directory
        mode: '0700'

    # =========================================
    # Load or Generate Registry Password (Persistent)
    # =========================================
    - name: Check if registry password file exists
      ansible.builtin.stat:
        path: "{{ registry_password_file }}"
      register: password_file

    - name: Read existing password
      when: password_file.stat.exists
      block:
        - name: Load password from file
          ansible.builtin.slurp:
            src: "{{ registry_password_file }}"
          register: password_content

        - name: Set registry password from file
          ansible.builtin.set_fact:
            registry_password: "{{ password_content.content | b64decode | trim }}"
          no_log: true

        - name: Info - Using existing password
          ansible.builtin.debug:
            msg: "‚ÑπÔ∏è  Using existing registry password from {{ registry_password_file }}"

    - name: Generate new password if not exists
      when: not password_file.stat.exists
      block:
        - name: Generate new registry password
          ansible.builtin.set_fact:
            registry_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
          no_log: true

        - name: Save new password to file
          ansible.builtin.copy:
            content: "{{ registry_password }}"
            dest: "{{ registry_password_file }}"
            mode: '0600'
          no_log: true

        - name: Info - Generated new password
          ansible.builtin.debug:
            msg: "üîë Generated new registry password and saved to {{ registry_password_file }}"

  tasks:
    # =========================================
    # Install apache2-utils for htpasswd
    # =========================================
    - name: Install apache2-utils for htpasswd
      ansible.builtin.apt:
        name:
          - apache2-utils
        state: present
        update_cache: true

    # =========================================
    # Configure MicroK8s to trust the registry
    # =========================================
    - name: Create MicroK8s containerd hosts directory
      ansible.builtin.file:
        path: /var/snap/microk8s/current/args/certs.d/{{ registry_domain }}
        state: directory
        mode: '0755'

    - name: Configure MicroK8s to trust registry
      ansible.builtin.copy:
        content: |
          server = "https://{{ registry_domain }}"

          [host."https://{{ registry_domain }}"]
            capabilities = ["pull", "resolve", "push"]
            # Trust the certificate (handled by cert-manager + ingress)
            skip_verify = false
        dest: /var/snap/microk8s/current/args/certs.d/{{ registry_domain }}/hosts.toml
        mode: '0644'
      notify: Restart MicroK8s containerd

    # =========================================
    # Save registry credentials summary file
    # =========================================
    - name: Save registry credentials summary
      ansible.builtin.copy:
        content: |
          # Container Registry Credentials
          # Generated: {{ ansible_date_time.iso8601 }}

          Registry URL:  https://{{ registry_domain }}
          Username:      {{ registry_username }}
          Password:      {{ registry_password }}

          Docker Login:
            docker login {{ registry_domain }} -u {{ registry_username }} -p '{{ registry_password }}'
        dest: /root/.fundamental-credentials/registry-credentials.txt
        mode: '0600'
      no_log: true

    # =========================================
    # Update Kubernetes secrets with registry credentials
    # =========================================
    - name: Update registry secret in fundamental-dev
      ansible.builtin.shell: |
        microk8s kubectl create secret docker-registry registry-credentials \
          --namespace=fundamental-dev \
          --docker-server='{{ registry_domain }}' \
          --docker-username='{{ registry_username }}' \
          --docker-password='{{ registry_password }}' \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Update registry secret in fundamental-prod
      ansible.builtin.shell: |
        microk8s kubectl create secret docker-registry registry-credentials \
          --namespace=fundamental-prod \
          --docker-server='{{ registry_domain }}' \
          --docker-username='{{ registry_username }}' \
          --docker-password='{{ registry_password }}' \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    # =========================================
    # Create htpasswd file for ingress basic auth
    # =========================================
    - name: Generate htpasswd file
      ansible.builtin.shell: |
        htpasswd -cb /tmp/registry-htpasswd '{{ registry_username }}' '{{ registry_password }}'
      no_log: true
      changed_when: true

    - name: Create registry-auth secret in fundamental-dev
      ansible.builtin.shell: |
        microk8s kubectl create secret generic registry-auth \
          --namespace=fundamental-dev \
          --from-file=auth=/tmp/registry-htpasswd \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Create registry-auth secret in fundamental-prod
      ansible.builtin.shell: |
        microk8s kubectl create secret generic registry-auth \
          --namespace=fundamental-prod \
          --from-file=auth=/tmp/registry-htpasswd \
          --dry-run=client -o yaml | microk8s kubectl apply -f -
      no_log: true
      failed_when: false

    - name: Clean up htpasswd file
      ansible.builtin.file:
        path: /tmp/registry-htpasswd
        state: absent

    # =========================================
    # Verification
    # =========================================
    - name: Display registry info
      ansible.builtin.debug:
        msg:
          - "‚úÖ Registry credentials configured"
          - "üåê URL: https://{{ registry_domain }}"
          - "üë§ Username: {{ registry_username }}"
          - "üîë Password stored in: {{ registry_password_file }}"
          - "üìÑ Summary saved to: /root/.fundamental-credentials/registry-credentials.txt"
          - ""
          - "‚ÑπÔ∏è  Registry is exposed via Kubernetes Ingress (managed by Helm)"
          - "üìã Secrets created: registry-credentials, registry-auth"
          - ""
          - "‚ö†Ô∏è  IMPORTANT: Run setup-github-secrets.yaml to sync credentials to GitHub:"
          - "   ansible-playbook playbooks/setup-github-secrets.yaml"

    # =========================================
    # Fetch credentials to local
    # =========================================
    - name: Fetch registry credentials to local machine
      ansible.builtin.fetch:
        src: /root/.fundamental-credentials/registry-credentials.txt
        dest: "{{ playbook_dir }}/../.credentials/{{ inventory_hostname }}-registry.txt"
        flat: true
      no_log: true

  handlers:
    - name: Restart MicroK8s containerd
      ansible.builtin.shell: |
        microk8s stop
        sleep 5
        microk8s start
        microk8s status --wait-ready
      async: 300
      poll: 10
