---
# ArgoCD Setup Playbook
# =====================
# Installs and configures ArgoCD on MicroK8s cluster
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/setup-argocd.yaml
#
# After running:
#   - ArgoCD UI available at: https://argocd.academind.ir
#   - Admin password saved to /root/.fundamental-credentials/argocd-password.txt

- name: Setup ArgoCD
  hosts: vps
  become: true
  gather_facts: true

  vars:
    argocd_namespace: argocd
    argocd_version: stable
    argocd_domain: argocd.academind.ir

  tasks:
    # =========================================
    # Create ArgoCD Namespace
    # =========================================
    - name: Create ArgoCD namespace
      ansible.builtin.command: "microk8s kubectl create namespace {{ argocd_namespace }}"
      register: ns_result
      changed_when: ns_result.rc == 0
      failed_when: ns_result.rc != 0 and 'AlreadyExists' not in ns_result.stderr

    # =========================================
    # Install ArgoCD
    # =========================================
    - name: Download ArgoCD manifest
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml"
        dest: /tmp/argocd-install.yaml
        mode: '0644'

    - name: Apply ArgoCD manifest
      ansible.builtin.command: "microk8s kubectl apply -n {{ argocd_namespace }} -f /tmp/argocd-install.yaml"
      register: argocd_apply
      changed_when: "'created' in argocd_apply.stdout or 'configured' in argocd_apply.stdout"

    - name: Wait for ArgoCD server to be ready
      ansible.builtin.command: >
        microk8s kubectl wait --for=condition=available
        --timeout=300s deployment/argocd-server
        -n {{ argocd_namespace }}
      changed_when: false
      retries: 3
      delay: 10

    # =========================================
    # Configure ArgoCD Ingress
    # =========================================
    - name: Create ArgoCD Ingress
      ansible.builtin.copy:
        content: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-server-ingress
            namespace: {{ argocd_namespace }}
            annotations:
              nginx.ingress.kubernetes.io/ssl-passthrough: "true"
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
          spec:
            ingressClassName: public
            rules:
              - host: {{ argocd_domain }}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: argocd-server
                          port:
                            number: 443
            tls:
              - hosts:
                  - {{ argocd_domain }}
                secretName: argocd-tls
        dest: /tmp/argocd-ingress.yaml
        mode: '0644'

    - name: Apply ArgoCD Ingress
      ansible.builtin.command: "microk8s kubectl apply -f /tmp/argocd-ingress.yaml"
      register: ingress_apply
      changed_when: "'created' in ingress_apply.stdout or 'configured' in ingress_apply.stdout"

    # =========================================
    # Get ArgoCD Admin Password
    # =========================================
    - name: Get ArgoCD initial admin password
      ansible.builtin.shell: |
        microk8s kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false
      no_log: true

    - name: Save ArgoCD password
      ansible.builtin.copy:
        content: |
          # ArgoCD Credentials
          # Generated: {{ ansible_date_time.iso8601 }}
          
          URL:      https://{{ argocd_domain }}
          Username: admin
          Password: {{ argocd_password.stdout }}
        dest: /root/.fundamental-credentials/argocd-password.txt
        mode: '0600'
      no_log: true

    # =========================================
    # Install ArgoCD CLI
    # =========================================
    - name: Download ArgoCD CLI
      ansible.builtin.get_url:
        url: https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        dest: /usr/local/bin/argocd
        mode: '0755'

    # =========================================
    # Configure ArgoCD for insecure mode (for HTTP ingress)
    # =========================================
    - name: Patch ArgoCD server for insecure mode
      ansible.builtin.command: >
        microk8s kubectl patch deployment argocd-server
        -n {{ argocd_namespace }}
        --type='json'
        -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--insecure"}]'
      register: patch_result
      changed_when: "'patched' in patch_result.stdout"
      failed_when: false

    # =========================================
    # Verification
    # =========================================
    - name: Verify ArgoCD deployment
      ansible.builtin.command: "microk8s kubectl get pods -n {{ argocd_namespace }}"
      register: argocd_pods
      changed_when: false

    - name: Display ArgoCD info
      ansible.builtin.debug:
        msg:
          - "‚úÖ ArgoCD installed successfully"
          - "üåê URL: https://{{ argocd_domain }}"
          - "üë§ Username: admin"
          - "üîë Password saved to: /root/.fundamental-credentials/argocd-password.txt"
          - ""
          - "Pods:"
          - "{{ argocd_pods.stdout_lines }}"

    # =========================================
    # Fetch ArgoCD password to local
    # =========================================
    - name: Fetch ArgoCD credentials to local machine
      ansible.builtin.fetch:
        src: /root/.fundamental-credentials/argocd-password.txt
        dest: "{{ playbook_dir }}/../.credentials/{{ inventory_hostname }}-argocd.txt"
        flat: true
      no_log: true
