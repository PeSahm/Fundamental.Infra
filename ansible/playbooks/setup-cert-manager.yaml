---
# Cert-Manager Setup Playbook
# ===========================
# Configures cert-manager with Let's Encrypt ClusterIssuers for automatic TLS
#
# Prerequisites:
#   - MicroK8s with cert-manager addon enabled
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/setup-cert-manager.yaml
#
# Variables:
#   - letsencrypt_email: Email for Let's Encrypt notifications

- name: Setup Cert-Manager ClusterIssuers
  hosts: vps
  become: true
  gather_facts: true

  vars:
    letsencrypt_email: "mostafa.gamer.77@gmail.com"

  tasks:
    # =========================================
    # Wait for cert-manager to be ready
    # =========================================
    - name: Wait for cert-manager deployment
      ansible.builtin.command: >
        microk8s kubectl wait --for=condition=available
        --timeout=300s deployment/cert-manager
        -n cert-manager
      changed_when: false
      retries: 3
      delay: 10

    - name: Wait for cert-manager webhook
      ansible.builtin.command: >
        microk8s kubectl wait --for=condition=available
        --timeout=300s deployment/cert-manager-webhook
        -n cert-manager
      changed_when: false
      retries: 3
      delay: 10

    # =========================================
    # Create Let's Encrypt Staging ClusterIssuer
    # =========================================
    - name: Create Let's Encrypt Staging ClusterIssuer
      ansible.builtin.copy:
        content: |
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-staging
          spec:
            acme:
              email: {{ letsencrypt_email }}
              server: https://acme-staging-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-staging-account-key
              solvers:
                - http01:
                    ingress:
                      class: public
        dest: /tmp/clusterissuer-staging.yaml
        mode: '0644'

    - name: Apply Let's Encrypt Staging ClusterIssuer
      ansible.builtin.command: "microk8s kubectl apply -f /tmp/clusterissuer-staging.yaml"
      register: staging_apply
      changed_when: "'created' in staging_apply.stdout or 'configured' in staging_apply.stdout"

    # =========================================
    # Create Let's Encrypt Production ClusterIssuer
    # =========================================
    - name: Create Let's Encrypt Production ClusterIssuer
      ansible.builtin.copy:
        content: |
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              email: {{ letsencrypt_email }}
              server: https://acme-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-prod-account-key
              solvers:
                - http01:
                    ingress:
                      class: public
        dest: /tmp/clusterissuer-prod.yaml
        mode: '0644'

    - name: Apply Let's Encrypt Production ClusterIssuer
      ansible.builtin.command: "microk8s kubectl apply -f /tmp/clusterissuer-prod.yaml"
      register: prod_apply
      changed_when: "'created' in prod_apply.stdout or 'configured' in prod_apply.stdout"

    # =========================================
    # Verification
    # =========================================
    - name: Wait for ClusterIssuers to be ready
      ansible.builtin.pause:
        seconds: 10

    - name: Verify ClusterIssuers
      ansible.builtin.command: "microk8s kubectl get clusterissuers"
      register: clusterissuers
      changed_when: false

    - name: Display cert-manager info
      ansible.builtin.debug:
        msg:
          - "✅ Cert-Manager ClusterIssuers configured"
          - ""
          - "Available Issuers:"
          - "{{ clusterissuers.stdout_lines }}"
          - ""
          - "Usage in Ingress:"
          - "  annotations:"
          - "    cert-manager.io/cluster-issuer: letsencrypt-prod"
          - ""
          - "⚠️  Use letsencrypt-staging first for testing to avoid rate limits"
